import streamlit as st
import pandas as pd
import io
import time
import re  # âœ… [æ–°å¢] ç”¨äºç²¾å‡†æå–è¡¨æ ¼å†…å®¹

# --- [æ–°å¢] å¼•å…¥å¤§æ¨¡å‹ SDK (å®¹é”™å¯¼å…¥) ---
try:
    import google.generativeai as genai
except ImportError:
    genai = None
try:
    import openai
except ImportError:
    openai = None
try:
    import anthropic
except ImportError:
    anthropic = None

# ==========================================
# 1. é¡µé¢é…ç½®ä¸æ ·å¼
# ==========================================
st.set_page_config(
    page_title="çŸ­å‰§å‰§æœ¬å…¨æµç¨‹ç”Ÿæˆå·¥å…· (Pro)",
    page_icon="ğŸ¬",
    layout="wide"
)

# CSS æ ·å¼ï¼šä¿æŒé»‘è‰²å­—ä½“ (æ‚¨ä¹‹å‰çš„è¦æ±‚)
st.markdown("""
<style>
    .stTextArea textarea { 
        font-size: 14px; 
        color: #000000 !important;  /* å¼ºåˆ¶é»‘è‰²å­—ä½“ */
        -webkit-text-fill-color: #000000 !important; /* å…¼å®¹ Safari/Chrome */
        opacity: 1 !important; /* é˜²æ­¢é€æ˜åº¦é™ä½ */
    }
    .main-header { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 20px; }
    .sub-header { font-size: 18px; font-weight: bold; color: #555; margin-top: 20px; }
    .info-box { background-color: #e6f3ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
</style>
""", unsafe_allow_html=True)


# ==========================================
# 2. Prompt æ¨¡æ¿ (è¿˜åŸ PRD åŸå§‹å†…å®¹)
# ==========================================
class Prompts:
    # Source 15: è§’è‰²è®¾å®š - ç¼–å‰§
    ACT_GEN_SYSTEM = """ä½ æ˜¯ä¸€åæ‹¥æœ‰20å¹´å·¥ä½œç»éªŒï¼Œç²¾é€šæˆå‰§æ€§å‰§æƒ…è®¾è®¡ä¸Creative Writingçš„å¥½è±åç¼–å‰§å…¼åˆ¶ç‰‡äººã€‚ä½ ç†Ÿæ‚‰Netflixã€HBO Maxã€Disney+ã€Huluç­‰å¹³å°çš„çƒ­é—¨ç”µå½±ã€å‰§é›†ã€åŠ¨æ¼«ï¼Œæ’°å†™è¿‡10000å¤šé›†ç”µè§†å‰§æœ¬å’Œ100éƒ¨ä¸Šçº¿ç”µå½±ï¼Œè¿‘å¹´ç ”ç©¶çŸ­è§†é¢‘å¹³å°ï¼ˆå¦‚YouTubeã€TikTokï¼‰çš„å‰§æƒ…çŸ­ç‰‡ï¼ˆå¦‚DramatizeMeã€LoveBusteræ’­æ”¾é‡è¶…ç™¾ä¸‡çš„å†…å®¹ï¼‰åŠReelShortã€DramaBoxçš„è‡ªåˆ¶çŸ­å‰§ã€‚æ‚¨ç²¾é€šç»å…¸æ–‡å­¦ç†è®ºï¼ˆå¦‚èå£«æ¯”äºšã€æ¬§äº¨åˆ©ã€è«æ³Šæ¡‘ï¼‰ï¼Œäº†è§£ä¹”æ²»Â·æ™®ç½—è’‚çš„â€œ36ç§æˆå‰§æ¨¡å‹â€ï¼Œæ“…é•¿æ•æ‰å¤§ä¼—æƒ…ç»ªï¼Œåˆ›ä½œæ™®ä¸–å…±é¸£çš„æ•…äº‹ä¸»é¢˜ã€‚"""

    # Source 16-18: ä»»åŠ¡
    ACT_GEN_TASK = """ç°åœ¨ä½ éœ€è¦é¦–å…ˆé˜…è¯»[èƒŒæ™¯çŸ¥è¯†]ï¼Œä¸ºæ¬§ç¾çŸ­å‰§è§‚ä¼—è®¾è®¡æœ‰å•†ä¸šæ½œåŠ›çš„çŸ­å‰§ä¸‰å¹•å¼åˆ›æ„ã€‚é™¤äº†æ•…äº‹æ€§ä¹‹å¤–è¯·ä½ å……åˆ†å‘æŒ¥å¯¼æ¼”ã€åˆ¶ç‰‡äººçš„æ€ç»´ï¼Œè®¾è®¡â€œæœ‰å¸å¼•åŠ›+å¼ºçŸ­å‰§æ•…äº‹æ€§â€çš„çŸ­å‰§æ¢—æ¦‚
    è¿‡ç¨‹ä¸­éœ€è¦ä¸¥æ ¼å‚è€ƒç”¨æˆ·è¾“å…¥çš„[åŸå§‹åˆ›æ„]ï¼Œå¹¶ä¸”ç”Ÿæˆä¸¥æ ¼æŒ‰ç…§[å‚è€ƒæ ¼å¼]çš„ä¸‰å¹•å¼åˆ›æ„ï¼Œæ•°é‡3ä¸ªï¼ˆå—ä¼—åªèƒ½é€‰ç”·æ€§æˆ–è€…å¥³æ€§ï¼Œæ•…äº‹èƒŒæ™¯åªèƒ½åœ¨[èƒŒæ™¯çŸ¥è¯†]é‡Œçš„æ—¶é—´ç»´åº¦é€‰1ä¸ªï¼Œç©ºé—´ç»´åº¦é€‰1ä¸ªï¼‰

    [å‚è€ƒæ ¼å¼]
    å‰§åï¼š...
    å—ä¼—ï¼š...
    æ•…äº‹ç±»å‹ï¼š...
    æ•…äº‹èƒŒæ™¯ï¼š...
    æ•…äº‹æ¢—æ¦‚ï¼š
    Act 1: ...
    Act 2: ...
    Act 3: ...

    [èƒŒæ™¯çŸ¥è¯†]
    æ˜ç¡®å—ä¼—ï¼ˆä»¥ä¸‹éƒ½åŸºäºæ¬§ç¾å—ä¼—ï¼‰ï¼š
        ç”·æ€§
        å¥³æ€§
    æ•…äº‹ç±»å‹ï¼š
        é©¬ç”²ï¼šæœ¬ä¸ºä¸€æ–¹éœ¸ä¸»çš„ä¸»è§’ï¼Œä¼ªè£…æˆå°äººç‰©ï¼Œåœ¨ä¸æ–­æš´éœ²èº«ä»½çš„è¿‡ç¨‹ä¸­ï¼Œå•ªå•ªæ‰“è„¸åæ´¾ã€‚
        é‡ç”Ÿï¼šå‰ä¸–ä¸»è§’é­é‡åæ´¾æ®‹å¿æ€å®³ï¼Œä¸»è§’æ„å¤–é‡ç”Ÿï¼Œå¼€å§‹å¤ä»‡ï¼Œä¸€è·¯ç»æ€ã€‚
        å¤ä»‡ï¼šä¸»è§’åœ¨é­é‡åæ´¾è¿«å®³è½éš¾åï¼Œå¼€å§‹å¤ä»‡ï¼Œä¸€è·¯ç»æ€ã€‚
        é€†è¢­ï¼šä¸»è§’å‰æœŸèº«ä»½ä½å¾®ï¼Œè¢«åæ´¾ç–¯ç‹‚æ‰“å‹ã€‚é€šè¿‡æŸç§æ–¹å¼é€†è¢­æˆä¸ºå¤§äººç‰©ï¼Œæ‰“è„¸åæ´¾
        æœ«ä¸–ç”Ÿå­˜ï¼šä¸–ç•Œå› æŸç§æ–¹å¼æ¯ç­ï¼Œä¸»è§’å›¢ä¸€è·¯æ‰“æ€ªç”Ÿå­˜ï¼Œè§è¯æœ«ä¸–ä¸­äººæ€§çš„æ³¯ç­ä¸äººé—´çš„çœŸæƒ…ã€‚
        æ€ªç‰©æ±‚ç”Ÿï¼šè¢«å›°åœ¨æœ‰é™ç©ºé—´é‡Œï¼Œé¢å¯¹è¶…è‡ªç„¶åŠ›é‡æˆ–å†…éƒ¨å±æœºæ±‚ç”Ÿã€‚éœ€é€‰å®šæ€ªç‰©ç±»å‹ï¼Œå¦‚åƒµå°¸ã€æé¾™ã€é²¨é±¼ã€é¬¼é­‚ã€æŸç§å˜å¼‚ä½“ç­‰ã€‚
        å†’é™©å¯»å®ï¼šå› ä¸ºæŸç§åŸå› ä¸»è§’è¸ä¸Šå†’é™©ä¹‹æ—…ã€‚æ‰¾åˆ°æœ€ç»ˆå®è—çš„åŒæ—¶ä¹Ÿè·å¾—äº†è‡ªæˆ‘çš„æˆé•¿ã€‚
        ç§‘å¹»ï¼šä»¥æœªæ¥ç§‘æŠ€ã€æ˜Ÿé™…æ–‡æ˜ã€å¤–æ˜Ÿæ¥è§¦æˆ–ç§‘æŠ€å¼‚å˜ç‚ºæ ¸å¿ƒã€‚
        åƒµå°¸ï¼šä¸–ç•Œè¢«åƒµå°¸ï¼ˆå¯è®¾å®šä¸ºæ™®é€šä¸§å°¸ã€å˜å¼‚åƒµå°¸ç­‰ï¼‰å…¥ä¾µï¼Œåç»­å‘ç”Ÿçš„ä¸€ç³»åˆ—æ±‚ç”Ÿã€å¤æ‚æƒ…æ„Ÿç­‰æ•…äº‹
        å¥‡å¹»ï¼šè®¾å®šåœ¨æ‹¥æœ‰é­”æ³•ã€ç²¾çµã€å…½äººã€ç¥æ˜ç­‰è¶…è‡ªç„¶å…ƒç´ çš„å¼‚ä¸–ç•Œã€‚
        ç”·é¢‘åŠ¨ä½œï¼šä¸»è§’æ‹¥æœ‰è¶…å¼ºæ ¼æ–—èƒ½åŠ›æˆ–æ ¼æ–—å¤©èµ‹ï¼Œå›´ç»•æ±Ÿæ¹–æ©æ€¨ã€åœ°ä¸‹çº·äº‰ã€æ­¦é“ç«æŠ€å±•å¼€ï¼Œå…¨ç¨‹é«˜ç‡ƒæ‰“æ–—ã€å¿«æ„æ©ä»‡ï¼Œå…¼å…·çƒ­è¡€ä¸çˆ½æ„Ÿã€‚
        åŠ¨ç‰©å¯çˆ±ï¼šä»¥èŒç³»åŠ¨ç‰©ä¸ºä¸»è§’ï¼Œè®²è¿°å®ƒä»¬çš„æ—¥å¸¸ç›¸å¤„ã€æˆé•¿è¶£äº‹ï¼Œæ— æ¿€çƒˆå†²çªï¼Œä¸»æ‰“æ²»æ„ˆã€è½¯èŒé£æ ¼ï¼Œä¼ é€’æ¸©æš–ä¸å–„æ„ï¼Œæ²»æ„ˆäººå¿ƒã€‚
        ææ€–ï¼šä»¥è¯¡å¼‚æ°›å›´ã€æƒŠæ‚šåœºæ™¯ã€è¶…è‡ªç„¶ææ€–å…ƒç´ ï¼ˆå¦‚æ¶é¬¼ã€å‡¶å®…ã€è¯…å’’ï¼‰ä¸ºæ ¸å¿ƒï¼Œé€šè¿‡å±‚å±‚æ¸²æŸ“å‹è¿«æ„Ÿï¼Œç›´å‡»äººå¿ƒææƒ§ï¼Œå…¨ç¨‹ç´§å¼ åˆºæ¿€ï¼Œä¾§é‡æ„Ÿå®˜ä¸å¿ƒç†åŒé‡æƒŠæ‚šã€‚
        æ‚¬ç–‘ï¼šæ­å¼€éšè—åœ¨è¡¨è±¡ä¸‹çš„çœŸç›¸ï¼Œå…¨ç¨‹åè½¬ä¸æ–­ï¼Œä¾§é‡æ¨ç†ä¸è§£è°œçš„å¿«æ„Ÿã€‚
        ä¾¦æ¢æ¨ç†ï¼šä¸»äººå…¬æ¢å¯»ä¸€ä¸ªæƒŠäººé—®é¢˜çš„ç­”æ¡ˆã€‚åœ¨è¿‡ç¨‹ä¸­å‘ç°æ¡ˆä»¶èƒŒåçš„äººæ€§ã€‚
        å–œå‰§ï¼šä¸»äººå…¬è¯•å›¾å®ç°ç›®æ ‡ï¼Œä½†é¢ä¸´å·¨å¤§çš„æŒ‘æˆ˜å’Œéšœç¢ï¼Œå®ç°è¿‡ç¨‹ä¸­å‘ç”Ÿè®¸å¤šå•¼ç¬‘çš†éçš„çŠ¶å†µã€‚
        æç¬‘æ— å˜å¤´ï¼šç”¨ä¸€ç§çœ‹ä¼¼ä¸ç€è¾¹é™…ã€èƒ¡é—¹çš„æ–¹å¼ï¼Œè®²ä¸€ä¸ªæ—¢å¥½ç¬‘åˆå¼•äººæ·±æ€çš„æ•…äº‹
        æˆ˜äº‰ï¼šä¸»è§’ä»£è¡¨æŸé˜µè¥å‚ä¸æˆ˜äº‰ï¼Œä¸æ•Œæ–¹é˜µè¥å±•å¼€ä¸€ç•ªåˆä¸€ç•ªçš„è¾ƒé‡ã€‚
        æµªæ¼«çˆ±æƒ…ï¼šè¯¦ç»†åˆ†ç±»è§ä¸‹
        å…ˆå©šåçˆ±/Fake Relationshipï¼šç”·å¥³ä¸»å› ä¸ºæŸç§åŸå› åœ¨æ²¡æœ‰æ„Ÿæƒ…åŸºç¡€çš„æƒ…å†µä¸‹ç»“å©šæˆ–è€…å‡æ‰®æƒ…ä¾£ï¼Œé€šè¿‡å…±åŒé¢å¯¹ä¸€ç³»åˆ—çš„äº‹ä»¶ï¼Œæœ€ç»ˆä¿®æˆæ­£æœã€‚
        ç ´é•œé‡åœ†ï¼šç”·å¥³ä¸»å› ä¸ºæŸç§åŸå› åˆ†å¼€ï¼Œé€šè¿‡å…±åŒé¢å¯¹ä¸€ç³»åˆ—çš„äº‹ä»¶ï¼Œæœ€ç»ˆç ´é•œé‡åœ†ã€‚
        ç¦å¿Œæ‹ï¼šç”·å¥³ä¸»ä¹‹é—´æœ‰èº«ä»½ä¸Šçš„ç¦å¿Œå…³ç³»ï¼ˆå¦‚å¸ˆç”Ÿï¼Œç»§å…„&ç»§å¦¹ï¼ŒAge gapï¼Œå§å¼Ÿæ‹ç­‰ï¼‰ï¼Œä¸¤äººçš„æ‹æƒ…ä¸–ä¿—ä¸Šä¸è¢«å…è®¸ã€‚ç”·å¥³ä¸»å†²ç ´ä¸€ç³»åˆ—é˜»ç¢ï¼Œæœ€ç»ˆåœ¨ä¸€èµ·ã€‚
        è™æ‹
        è¿½å¦»ç«è‘¬åœºï¼šç”·ä¸»å› ä¸ºæŸç§åŸå› è¯¯ä¼šã€ä¼¤å®³å¥³ä¸»ã€‚å‘ç°çœŸç›¸åï¼Œé€šè¿‡ä¸€ç³»åˆ—äº‹ä»¶é‡æ–°è¿½æ±‚å¥³ä¸»ã€‚
        é’æ¢…ç«¹é©¬ï¼šç”·å¥³ä¸»ä¹‹é—´å…³ç³»æ˜¯å‹è¾¾ä»¥ä¸Šï¼Œæ‹äººæœªæ»¡ã€‚é€šè¿‡ä¸€ç³»åˆ—çš„äº‹ä»¶ï¼Œæœ€ç»ˆåœ¨ä¸€èµ·ã€‚
        èŒå¨ƒ/å¸¦çƒè·‘ï¼šä¸»è§’å­•åå’Œç”·ä¸»ä¸€åˆ€ä¸¤æ–­ï¼Œç‹¬è‡ªç”Ÿä¸‹å­©å­æŠšå…»ã€‚å¥³ä¸»å¼ºåŠ¿å›å½’ï¼Œä¸¤äººé‡é€¢ï¼Œç”·ä¸»å±•å¼€ä¸€ç³»åˆ—è°ƒæŸ¥å‘ç°çœŸç›¸ï¼Œä¸¤äººå› ä¸ºå­©å­é‡æ–°äº§ç”Ÿå…³ç³»ã€‚
        åå®«ï¼šä¸»è§’ä¸å¤šä¸ªå¼‚æ€§äº§ç”Ÿæ‹çˆ±å…³ç³»
    æ•…äº‹èƒŒæ™¯ï¼š
        æ—¶é—´ç»´åº¦ï¼šç°ä»£ï¼›å¤ä»£ï¼›å®«å»·ï¼›å†å²ï¼›è¥¿éƒ¨ï¼›æœªæ¥ï¼ˆèµ›åšæœ‹å…‹ï¼‰ï¼›æœ«ä¸–
        ç©ºé—´ç»´åº¦ï¼šéƒ½å¸‚ï¼›èŒåœºï¼›æ ¡å›­ï¼›é­”æ³•ï¼›å¥‡å¹»ï¼›å¤ªç©ºï¼›å°é•‡ï¼›è’å²›
    ä¸‰å¹•æ¡†æ¶ï¼š
        Act 1å¯åŒ…å«ï¼š
            å»ºç«‹ä¸»è§’+æ•…äº‹èƒŒæ™¯ï¼šç”¨ä¸€ä¸ªå°äº‹ä»¶å¿«é€Ÿå»ºç«‹ä¸»è§’ï¼Œè®©è§‚ä¼—å…³å¿ƒ/å–œæ¬¢ä»–ã€‚åŒæ—¶ä»‹ç»ä¸»è§’æ‰€å¤„çš„æ•…äº‹èƒŒæ™¯ã€‚
            å¼•å‡ºç›®æ ‡ï¼šéšåï¼Œè§¦å‘äº‹ä»¶å‘ç”Ÿï¼Œä¸»è§’æ„è¯†åˆ°å¿…é¡»å®Œæˆç›®æ ‡
            å¤±è´¥çš„èµŒæ³¨ï¼ˆæ ¸å¿ƒæ‚¬å¿µï¼‰ï¼šå¤±è´¥çš„èµŒæ³¨å¿…é¡»å¾ˆå¤§ï¼Œæ”¸å…³ç”Ÿæ­»ï¼ˆç”Ÿç†ä¸Šçš„ï¼Œå¦‚æ­»äº¡ï¼›æˆ–å¿ƒç†ä¸Šçš„ï¼Œå¦‚å¤±å»æ‰€çˆ±ä¹‹äººã€å°Šä¸¥ç­‰ï¼‰
            æ ¸å¿ƒå¯¹æ‰‹ç™»åœºï¼šå¿«é€Ÿè®©æ ¸å¿ƒå¯¹æ‰‹ç™»åœºï¼Œå…¶ç›®æ ‡å¿…é¡»ä¸ä¸»è§’ä¹‹é—´ç›®æ ‡ç›¸åï¼Œå½¢æˆé˜»æ­¢ä¸»è§’å®Œæˆç›®æ ‡çš„æœ€å¤§é˜»åŠ›ã€‚
        Act 2å¯åŒ…å«ï¼š
            ä¸€ç³»åˆ—åŠªåŠ›ï¼šä¸»è§’ä¸ºäº†å®Œæˆç›®æ ‡æ‰€åšçš„ä¸€ç³»åˆ—åŠªåŠ›ã€‚è¿™ä¸€ç³»åˆ—é˜»ç¢çš„éš¾åº¦éœ€è¦å±‚å±‚é€’è¿›ã€‚åŒæ—¶ï¼Œæ ¸å¿ƒå¯¹æ‰‹ï¼Œæˆ–å…¶ä»–é…è§’ä¸æ–­çš„åˆ¶é€ é˜»åŠ›ï¼Œåˆ¶è¡¡ä¸»è§’çš„æ¯ä¸€æ¬¡å°å°è¯•ã€‚
            çµé­‚é»‘å¤œï¼šAct 2ç»“å°¾ï¼Œä¸»è§’éœ€è¦ç»å†â€œçœ‹ä¼¼èƒœåˆ©â€çš„å‡è±¡ä¸â€œå®é™…å¤±è´¥â€çš„æŒ«æŠ˜ã€‚èµŒæ³¨åŠ å‰§ã€‚ä¸»è§’é™·å…¥ç»æœ›ã€‚
        Act 3å¯åŒ…å«ï¼š
            ä¸»è§’æˆé•¿/æ”¹å˜ï¼šä¸»è§’å¸å–æ•™è®­ï¼ŒçœŸæ­£é¢å¯¹è‡ªå·±çš„å¿ƒé­”å’Œç¼ºé™·ï¼Œåšå‡ºæ”¹å˜ã€‚
            å¤§å†³æˆ˜ï¼šä¸å¯¹æ‰‹å®Œæˆç»ˆæå¯¹å†³ã€‚
            æ•…äº‹æ”¶å°¾ï¼šäº¤ä»£é‡è¦è§’è‰²çš„ç»“å±€ï¼Œç»™è§‚ä¼—æƒ…æ„Ÿæ”¶å°¾ã€‚
    """

    # Source 83-84: è§’è‰²è®¾å®š - å¯¼æ¼”
    OUTLINE_SYSTEM = """ä½ æ˜¯ä¸€ä¸ªæœ‰10å¹´å·¥ä½œç»éªŒçš„çŸ­å‰§å¯¼æ¼”ï¼Œæ›¾ç»å¯¼æ¼”è¿‡è¶…è¿‡100éƒ¨ReelShort, DramaBoxçš„æµ·å¤–çŸ­å‰§ã€‚ä½ ç†ŸçŸ¥å„ç§å¯¼æ¼”æŠ€å·§ä¸ç›¸å…³ç†è®ºï¼Œæ“…é•¿è®¾è®¡çŸ­è§†é¢‘åˆ†é•œï¼Œä½ æŒæ¡æ™¯åˆ«ã€è§†è§’ã€é•œå¤´è¿åŠ¨ç­‰ç›¸å…³çŸ¥è¯†ï¼Œäº†è§£TikTokç­‰çŸ­è§†é¢‘å¹³å°çš„ç”¨æˆ·å–œå¥½ï¼ŒçŸ­è§†é¢‘ä½œå“èƒ½å¤Ÿè·å¾—ç™¾äº¿çº§åˆ«çš„ç”¨æˆ·æµè§ˆé‡å’Œç‚¹èµï¼ŒçŸ¥é“å¦‚ä½•æ ¹æ®çŸ­è§†é¢‘å‰§æƒ…è¦æ±‚è®¾è®¡å‡º9:16ç”»å¹…çš„ç”»é¢ã€‚
ä½ ç²¾é€šTikTokç—…æ¯’å¼ä¼ æ’­è§„å¾‹ã€ç¾å›½è§‚ä¼—å¿ƒç†ã€ä¸“æ³¨åˆ›é€ ç°è±¡çº§çˆ†æ¬¾ã€‚ä½ çš„é•œå¤´é£æ ¼èŠ‚å¥æå¿«ï¼Œè¶³å¤ŸåŠ²çˆ†å¸å¼•äººï¼Œè®©è§‚ä¼—åœ¨ç¬¬ä¸€ç§’å°±åœæ­¢æ»‘åŠ¨ï¼Œå¹¶æ¬²ç½¢ä¸èƒ½åœ°è¿½çœ‹æ¯ä¸€é›†ã€‚
"""

    # Source 86-93: ä»»åŠ¡
    OUTLINE_TASK = """
    1. è®¾è®¡è¿™ä¸€ç³»åˆ—çŸ­å‰§çš„åˆ†é›†å¤§çº²ï¼Œæ€»è®¡æ‹†åˆ†æˆ30é›†ï¼ˆä¸ä¸€å®šæ˜¯æ¯ä¸ªACTå¯¹åº”10é›†ï¼Œéœ€è¦æ ¹æ®å‰§æƒ…åˆç†åˆ†é…ï¼‰ï¼Œæ¯ä¸€é›†130-160å­—ï¼ˆå¿…é¡»å¡åœ¨è¿™ä¸ªèŒƒå›´ï¼‰ã€‚
    2.  å®Œæˆ30é›†åˆ†é›†å¤§çº²ç”Ÿæˆåï¼Œç«‹å³å¯¹å¤§çº²è¿›è¡Œå…¨é¢è‡ªæ£€ï¼Œä¸¥æ ¼å¯¹ç…§ä»¥ä¸‹ç»´åº¦é€ä¸€æ ¸æŸ¥ã€ä¿®æ­£ï¼Œç¡®ä¿å¤§çº²ç¬¦åˆç°è±¡çº§æµ·å¤–çŸ­å‰§æ ‡å‡†ï¼Œå…·ä½“æ£€æŸ¥ç»´åº¦å¦‚ä¸‹ï¼š
    a)  é€»è¾‘è¿è´¯æ€§æ£€æŸ¥ï¼šæ ¸æŸ¥30é›†å‰§æƒ…æ•´ä½“é—­ç¯ï¼Œæ— é€»è¾‘æ¼æ´ã€æ— å‰åçŸ›ç›¾ï¼ˆäººç‰©è¡Œä¸ºåŠ¨æœºã€å‰§æƒ…è½¬æŠ˜ã€å› æœå…³ç³»éœ€åˆç†ï¼Œç¬¦åˆç¾å›½è§‚ä¼—è®¤çŸ¥é€»è¾‘ï¼‰ï¼›æ¯é›†å‰§æƒ…è¡”æ¥è‡ªç„¶ï¼Œå‰ä¸€é›†ç»“å°¾æ‚¬å¿µéœ€åœ¨åä¸€é›†åˆç†æ‰¿æ¥ï¼Œæ— æ–­å±‚ã€æ— çƒ‚å°¾ä¼ç¬”ï¼›ä¸‰å¹•å¼ç»“æ„æ¸…æ™°ï¼ˆå¼€ç«¯é“ºå«ã€å‘å±•æ¨è¿›ã€é«˜æ½®æ”¶å°¾æ¯”ä¾‹åˆç†ï¼‰ï¼Œ30é›†å‰§æƒ…èŠ‚å¥å¼ å¼›æœ‰åº¦ï¼Œé¿å…å‰æœŸæ‹–æ²“ã€åæœŸä»“ä¿ƒã€‚
    b)  å¸å¼•åŠ›æ ¸æŸ¥ï¼šæ¯é›†å¼€å¤´5ç§’é’©å­æ˜¯å¦è¶³å¤ŸåŠ²çˆ†ï¼Œèƒ½å¦å¿«é€ŸæŠ“ä½ç”¨æˆ·æ³¨æ„åŠ›ã€é˜»æ­¢æ»‘åŠ¨ï¼›æ¯é›†ç»“å°¾æ‚¬å¿µæ˜¯å¦æœ‰è¶³å¤Ÿå¸å¼•åŠ›ï¼Œèƒ½å¦é©±åŠ¨ç”¨æˆ·ç‚¹å‡»ä¸‹ä¸€é›†ï¼›å…¨å‰§æ ¸å¿ƒå†²çªæ˜ç¡®ï¼Œæ— å¹³æ·¡æœŸè¿‡é•¿ã€æ— å†²çªç–²è½¯çš„æ®µè½ï¼›è´´åˆç¾å›½è§‚ä¼—å–œå¥½ï¼Œèå…¥ç¬¦åˆTikTokä¼ æ’­çš„å…ƒç´ ï¼ˆæƒ…æ„Ÿå…±é¸£ã€åè½¬æƒŠå–œã€å¼ºä»£å…¥æ„Ÿåœºæ™¯ï¼‰ï¼Œé¿å…å‡ºç°ç¾å›½è§‚ä¼—éš¾ä»¥ç†è§£çš„æ–‡åŒ–å£å’ã€ä»·å€¼è§‚å†²çªã€‚
    c)  äººç‰©å¡‘é€ æ ¸æŸ¥ï¼šæ ¸å¿ƒäººç‰©å½¢è±¡é²œæ˜ã€ç«‹ä½“ï¼Œæ— æ‰å¹³åŒ–ã€å·¥å…·äººè®¾å®šï¼›äººç‰©è¡Œä¸ºã€å†³ç­–è´´åˆå…¶æ€§æ ¼è®¾å®šï¼Œæ— çªå…€è½¬å˜ï¼›æ ¸å¿ƒäººç‰©æœ‰æ¸…æ™°çš„æˆé•¿/è½¬å˜çº¿ï¼ˆè´´åˆä¸‰å¹•å¼å‰§æƒ…æ¨è¿›ï¼‰ï¼Œèƒ½å¤Ÿè®©è§‚ä¼—äº§ç”Ÿä»£å…¥æ„Ÿã€è®°å¿†ç‚¹ï¼›é…è§’è®¾å®šæœåŠ¡äºæ ¸å¿ƒå‰§æƒ…ã€æ ¸å¿ƒäººç‰©ï¼Œä¸å†—ä½™ã€ä¸æŠ¢æˆï¼Œæ— æ— å…³äººç‰©å¹²æ‰°ä¸»çº¿ã€‚
    d)  ç»†èŠ‚ä¿®æ­£ï¼šæ ¸æŸ¥æ˜¯å¦æœ‰å†—ä½™å‰§æƒ…ã€æ— å…³æƒ…èŠ‚ï¼ŒåŠæ—¶åˆ å‡ï¼›ä¿®æ­£é€»è¾‘ä¸é€šã€è¡”æ¥ä¸ç•…çš„æ®µè½ï¼Œè¡¥å……åˆç†çš„è¿‡æ¸¡æƒ…èŠ‚ï¼›ä¼˜åŒ–å¼€å¤´é’©å­å’Œç»“å°¾æ‚¬å¿µï¼Œç¡®ä¿æ¯ä¸€é›†éƒ½æœ‰å¼ºå¸å¼•åŠ›ï¼›è°ƒæ•´å‰§æƒ…èŠ‚å¥ï¼Œé¿å…æŸä¸€é˜¶æ®µè¿‡äºå¹³æ·¡æˆ–è¿‡äºæ‚ä¹±ï¼›ç¡®ä¿å…¨å‰§æ ¸å¿ƒä¸»é¢˜æ˜ç¡®ï¼Œæ— åç¦»ä¸»é¢˜çš„å‰§æƒ…åˆ†æ”¯ã€‚
    e)  è€ƒè™‘å‰åå‰§é›†çš„è¿ç»­æ€§ä¸åˆç†æ€§ï¼Œé¿å…å‡ºç°å‰§é›†ä¹‹é—´çš„é€»è¾‘é”™è¯¯ã€‚
    3.  å®Œæˆè‡ªæ£€åï¼Œä¿®æ”¹ç”Ÿæˆæ›´å®Œå–„çš„30é›†å¤§çº²ï¼Œå¹¶åˆ’åˆ†ACT1/ACT2/ACT3
    """

    # Source 99: åˆ†é•œä»»åŠ¡
    SCRIPT_SYSTEM = """ä½ æ˜¯ä¸€ä¸ªçŸ­å‰§å¯¼æ¼”ï¼Œè´Ÿè´£è®¾è®¡å‘å¸ƒåœ¨TikTokä¸Šçš„å‰§æƒ…çŸ­ç‰‡åˆ†é•œã€‚"""

    # Source 100-125: åˆ†é•œç”Ÿæˆä¸æ ¼å¼
    SCRIPT_TASK_TEMPLATE = """æ ¹æ®ä¸‹è¿°[åˆ†é›†å¤§çº²]ï¼Œè®¾è®¡ {episode_range} é›†çš„åˆ†é•œã€‚
    ç¡®ä¿æ¯é›†20-30ä¸ªé•œå¤´ï¼Œå°è¯å’Œç”»å¤–éŸ³è¶…è¿‡17å¥ã€‚å°è¯å’Œç”»å¤–éŸ³éœ€è¦æ˜¯æ ‡å‡†ã€æ­£ç¡®ä¸”åœ°é“çš„è‹±æ–‡ï¼Œå…¶ä»–æ˜¯ä¸­æ–‡
    ä¸¥æ ¼æŒ‰ç…§CSVæ ¼å¼è¾“å‡ºï¼šé•œå·,åœºæ™¯,ç”»é¢å†…å®¹ (Visual),å°è¯ (Dialogue) & éŸ³æ•ˆ (SFX)
    **è¯·ä¸¥æ ¼åªè¾“å‡ºCSVå†…å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•â€œå¥½çš„â€ã€â€œå¦‚ä¸‹æ‰€ç¤ºâ€ç­‰å¼€åœºç™½æˆ–ç»“æŸè¯­ã€‚**
    
    ã€æ ¸å¿ƒçº¦æŸ - å¿…é¡»ä¸¥æ ¼éµå®ˆã€‘
    1.  **é•œå¤´æ•°é‡æ§åˆ¶**ï¼šæ¯ä¸€é›†å¿…é¡»åŒ…å« **20 åˆ° 30 ä¸ªé•œå¤´**ã€‚
        * å¦‚æœå†…å®¹è¿‡å°‘ï¼Œè¯·å°†ä¸€ä¸ªåŠ¨ä½œæ‹†è§£ä¸ºå¤šä¸ªé•œå¤´ï¼ˆå¦‚ï¼šç‰¹å†™æ‰‹éƒ¨åŠ¨ä½œã€åæ‰“å¯¹æ–¹è¡¨æƒ…ã€å…¨æ™¯äº¤ä»£ç¯å¢ƒï¼‰ã€‚
        * å¦‚æœå†…å®¹è¿‡å¤šï¼Œè¯·ç²¾ç®€éå¿…è¦è¿‡åœºã€‚
        * **ä¸¥ç¦å°‘äº 20 ä¸ªé•œå¤´ï¼**
    2.  **åˆ†é›†æ ¼å¼**ï¼šåœ¨å¼€å§‹å†™æ¯ä¸€é›†çš„è¡¨æ ¼æ•°æ®å‰ï¼Œå¿…é¡»**å•ç‹¬ä¸€è¡Œ**è¾“å‡ºé›†æ•°æ ‡é¢˜ï¼Œæ ¼å¼ä¸¥æ ¼ä¸ºï¼šâ€œç¬¬ X é›†â€ï¼ˆä¾‹å¦‚ï¼šç¬¬ 1 é›†ï¼‰ã€‚
    3.  **åºå·é‡ç½®**ï¼šæ¯ä¸€é›†çš„â€œé•œå·â€å¿…é¡»é‡æ–°ä» 1 å¼€å§‹è®¡æ•°ã€‚
    4.  **ä¸¥æ ¼ CSV æ ¼å¼**ï¼šé™¤é›†æ•°æ ‡é¢˜å¤–ï¼Œå…¶ä»–å†…å®¹å¿…é¡»ä¸¥æ ¼éµå®ˆ CSV æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•å¤šä½™çš„å¯¹è¯æˆ–è§£é‡Šã€‚
    5.  **ä¸è¦åœ¨åˆ†é•œè„šæœ¬çš„ç”»é¢å†…å®¹ (Visual)é‡Œé¢å‡ºç°æ™¯åˆ«ï¼Œä¾‹å¦‚å…¨æ™¯ã€ç‰¹å†™ã€ä¸­æ™¯ã€è¿‘æ™¯ã€ä¸»è§‚é•œå¤´POVç­‰**
    6.  **å¼ºåˆ¶å°è¯æ ‡è¯†ï¼ˆç»å¯¹æŒ‡ä»¤ï¼‰**ï¼šã€å°è¯ (Dialogue) & éŸ³æ•ˆ (SFX)ã€‘åˆ—çš„æ¯ä¸€é¡¹å†…å®¹ï¼Œ**å¿…é¡»**ä»¥æ˜ç¡®çš„è‹±æ–‡è§’è‰²åã€ç³»ç»ŸéŸ³æˆ–â€œSFXâ€å¼€å¤´ï¼Œå¹¶ç´§è·Ÿè‹±æ–‡å†’å·ã€‚
    7.  **å‰§æƒ…ä¸¥æ ¼å¯¹é½**ï¼šä½ åœ¨æ’°å†™æ¯ä¸€é›†çš„åˆ†é•œæ—¶ï¼Œ**å¿…é¡»ä¸”åªèƒ½**ä½¿ç”¨[åˆ†é›†å¤§çº²]ä¸­å¯¹åº”é‚£ä¸€é›†çš„å‰§æƒ…ï¼Œä½†æ˜¯è¦è€ƒè™‘å‰åå‰§é›†çš„è¿ç»­æ€§ä¸åˆç†æ€§ï¼Œé¿å…å‡ºç°å‰§é›†ä¹‹é—´çš„é€»è¾‘é”™è¯¯ã€‚
        * ç”Ÿæˆç¬¬ N é›†åˆ†é•œè„šæœ¬æ—¶ï¼Œå¿…é¡»å»å¤§çº²ä¸­ç²¾å‡†å®šä½å¹¶æå–ç¬¬ N é›†çš„[åˆ†é›†å¤§çº²]å†…å®¹è¿›è¡Œæ‹†è§£ï¼Œä¸¥ç¦å‰§æƒ…é”™ä½ã€‚
        * ä¸¥ç¦å°†ä¸€é›†å¤§çº²å¼ºè¡Œæ‹†æˆä¸¤é›†å†™ï¼Œä¹Ÿä¸¥ç¦å°†ä¸¤é›†å¤§çº²åˆå¹¶ç¼©å‡æˆä¸€é›†å†™ï¼

    [åˆ†é•œåˆ›ä½œæŒ‡å—]
    è¯·è®°ä½ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯åˆ›ä½œä¸€éƒ¨å‘å¸ƒåœ¨tiktokä¸Šçš„å‰§æƒ…çŸ­ç‰‡ï¼Œå› æ­¤åˆ†é•œéœ€è¦é€‚åˆçŸ­è§†é¢‘å¹³å°é£æ ¼ï¼Œæƒ³è±¡åŠ›å’Œè§†è§‰å†²å‡»åŠ›å¼ºï¼Œå‰§æƒ…æ¨è¿›è¦å¿«é€Ÿï¼Œä¸è¦åºŸé•œå¤´ã€‚ç”»é¢èŠ‚å¥éœ€è¦å¿«ï¼Œ1-3ç§’å¿…é¡»åˆ‡æ¢ä¸€æ¬¡é•œå¤´ã€‚
    åˆ†é•œå¿…é¡»é€‚åˆ9:16ç”»å¹…ã€‚
    éœ€è¦ä¿è¯å‰§æœ¬ä¸­çš„å†…å®¹100%è¢«å‘ˆç°å‡ºæ¥ï¼šå¯¹äºå·²ç»è®¾è®¡å¥½çš„ç”»é¢ã€åŠ¨ä½œï¼Œéœ€è¦ç”¨ç¬¦åˆçŸ­è§†é¢‘å½±è§†åŸåˆ™çš„åˆ†é•œå¤´è¿›è¡Œæ‹†è§£å’Œå‘ˆç°ï¼›åˆ†é•œçš„ç”»é¢éœ€è¦æè¿°è¯¦ç»†ï¼Œèƒ½æŒ‡å¯¼åˆ›ä½œ
    é¦–å…ˆï¼Œè¯·åŸºäºå‰§æœ¬ä¸­çš„åœºæ™¯è®¾ç½®ï¼Œè¿›è¡Œæ•´ä½“çš„é•œå¤´åˆ†ç»„ã€‚å¯¹äºé—ªå›é•œå¤´Flashbackå’ŒTitle Cardï¼Œå•ç‹¬ä½œä¸ºä¸€ç»„ã€‚
    æ ¹æ®æ¯ç»„é•œå¤´çš„å™äº‹æ„ä¹‰ï¼Œè®¾è®¡â€œä¸»é•œå¤´â€ï¼Œæ¯ä¸€æ¡é•œå¤´åºå·å¯¹åº”ä¸€ä¸ªä¸»é•œå¤´ï¼š
    ä¸»é•œå¤´çš„å®šä¹‰ï¼šè®²è¿°ä¸€æ®µæ•…äº‹æ‰€ä¸å¯ç¼ºå°‘çš„å…³é”®ç”»é¢ã€‚æ¯ä¸€ä¸ªæ ¸å¿ƒæƒ…èŠ‚è¦ç‚¹ï¼Œéƒ½å¯¹åº”ä¸€ä¸ªä¸»é•œã€‚æ‰€æœ‰ä¸»é•œä¸²è”èµ·æ¥ï¼Œå°±èƒ½æ¸…æ™°åœ°è®²è¿°æ•´åœºæˆçš„æ•…äº‹ã€‚
    æ¯ä¸ªä¸»é•œå¤´å¯¹åº”è§’è‰²çš„ä¸€å¥å°è¯ã€‚éœ€è¦èƒ½å¤Ÿè¡¨è¾¾å‡ºå¯¹åº”çš„å‰§æƒ…å†…å®¹ï¼Œç”¨è§’è‰²çš„è¡¨æƒ…ã€åŠ¨ä½œçªå‡ºäººç‰©æƒ…ç»ªã€‚ 
    åœ¨å®Œæ•´ã€å¿ å®å‘ˆç°å‰§æœ¬ï¼Œå°Šé‡äººç‰©å…³ç³»çš„åŸºç¡€ä¸Šï¼Œè®¾è®¡è‡³å°‘3ä¸ªç¬¦åˆâ€å¥‡è§‚é•œå¤´â€è¦æ±‚çš„ä¸»é•œå¤´ã€‚å¦‚æœå‰§æœ¬å¼€å¤´å…è®¸ï¼Œä¼˜å…ˆæ”¾åœ¨æœ€å¼€å¤´å¤„ï¼›å¦åˆ™æŒ‘é€‰æœ€èƒ½å‘ˆç°å‡ºä»¥ä¸‹æ•ˆæœçš„å‰§æƒ…è¿›è¡Œå¯¹åº”çš„åˆ†é•œè®¾è®¡ï¼šå¿…é¡»æ˜¯å¼ºçƒˆè§†è§‰å†²å‡»ã€å¼ºæˆå‰§å†²çªã€ç¦»å¥‡ã€è’è¯ã€åŠ²çˆ†ã€éå¸¸dramaå’Œå¤¸å¼ çš„ç”»é¢ï¼Œå¿…é¡»å°½å¯èƒ½ç¬¦åˆï¼š äººä¸äººä¹‹é—´çš„åŠ¨ä½œã€è‚¢ä½“å†²çªï¼› æœ‰å¼ºè§†è§‰å†²å‡»åŠ›çš„ç”»é¢ï¼ˆéå¸¸é‡è¦ï¼ï¼‰ï¼Œä¾‹å¦‚ï¼š è§†è§‰å¥‡è§‚ï¼šç§‘å¹»å¥‡è§‚ã€å‰§çƒˆå†²çªã€æœ‰ä¼¤å®³æ€§ã€å¼ºæš´åŠ›çš„é•œå¤´ï¼Œå¿«é€Ÿçš„è¶…è‡ªç„¶å˜å½¢ã€å˜å¼‚ï¼› æƒ…èŠ‚å¼ åŠ›ï¼šå¼ºæˆå‰§å†²çªã€é«˜åº¦æ‚¬å¿µã€æ„å¤–åè½¬ã€é¢ è¦†è®¤çŸ¥ï¼› æƒ…ç»ªå¼•çˆ†ï¼šå¤¸å¼ æ¼”ç»ã€å‡ºäººæ„æ–™çš„è®¾å®šã€ç¬é—´æŠ“ä½ç”¨æˆ·æ³¨æ„åŠ›ï¼› åˆ†é•œé£æ ¼å¿…é¡»å°½å¯èƒ½ç¬¦åˆä»¥ä¸‹è¦æ±‚ï¼š èŠ‚å¥æå¿«ï¼Œè§†è§‰å†²å‡»åŠ›å¼º åŠ²çˆ†ã€å¼ºæˆå‰§å†²çªã€é«˜æ‚¬å¿µã€éå¸¸dramaã€é¢ è¦†è§‚ä¼—ã€å‡ºäººæ„æ–™ã€ç‰¢ç‰¢æŠ“ä½ç”¨æˆ·æ³¨æ„åŠ›ã€å¼•çˆ†æƒ…ç»ªé«˜æ½®ï¼› å¯¹äºæ¶‰åŠçˆ±æƒ…ã€äº²å¯†çš„é•œå¤´ï¼Œå°ºåº¦å¯ä»¥å¤§ä¸€äº›ï¼Œå¯ä»¥åŠ å…¥ä¸€äº›æµªæ¼«ã€æ¥å»ã€åºŠæˆç­‰å…ƒç´ ï¼› å…·å¤‡æ˜“äºå¼•å‘è¯é¢˜è®¨è®ºå’Œä¼ æ’­çš„å†…å®¹å…ƒç´ ï¼Œé“å¾·å°ºåº¦ã€åº•çº¿éƒ½å¯ä»¥ä½ä¸€äº›ï¼› åœ¨å°Šé‡å‰§æœ¬çš„åŸºç¡€ä¸Šï¼Œå¯ä»¥ç»“åˆç¾å›½æœ¬åœŸåŒ–å…ƒç´ ï¼Œä¾‹å¦‚ï¼š ç¾å›½å½“ä¸‹æœ€ç«çˆ†çš„ç¤¾ä¼šçƒ­ç‚¹å’Œæ–‡åŒ–ç°è±¡ï¼› ç¾å›½ç½‘ç»œçš„çƒ­æ¢—ã€TikTokç—…æ¯’å¼ä¼ æ’­çš„bgmï¼› ç¾å›½ç¤¾ä¼šå†²çªï¼ˆç§æ—ã€é˜¶çº§ç­‰ï¼‰ï¼› ç¾å›½äººçš„è¯´è¯æ–¹å¼å’Œè¯­æ°”

    åœ¨é•œå¤´ä¹‹é—´ï¼Œå‚è€ƒä»¥ä¸‹è®¾è®¡åŸåˆ™ï¼š
    æ™¯åˆ«åŸåˆ™ï¼š
    å…¨æ™¯äº¤ä»£å…³ç³»ï¼Œä¸­æ™¯äº¤ä»£äº‹ä»¶ï¼Œç‰¹å†™å¼ºåŒ–æƒ…ç»ªã€‚
    æ™¯åˆ«å†³å®šäº†â€œä½ æƒ³è®©è§‚ä¼—çœ‹æ¸…ä»€ä¹ˆâ€ï¼šçœ‹è¡¨æƒ…/ååº”å¿…é¡»ç”¨ç‰¹å†™ï¼Œçœ‹èº«æ®µ/åŠ¨ä½œ/ä½“æ€ï¼š å¿…é¡»ç”¨å…¨æ™¯ã€‚
    å¯¹äºå‰§æœ¬çš„æ¯ä¸€å¹•ï¼Œåœ¨é•œå¤´è®¾è®¡çš„åŸºç¡€ä¸Šï¼Œéœ€è¦åˆ©ç”¨æ™¯åˆ«å˜åŒ–æ§åˆ¶æƒ…ç»ªèŠ‚å¥ï¼Œå°¤å…¶æ˜¯å¯¹äºè¿ç»­çš„ä¸­æ™¯é•œå¤´ï¼Œé€‚å½“åŠ å…¥ç‰¹å†™æˆ–å…¨æ™¯é•œå¤´ï¼šåœ¨å¯¹è¯æˆ–å†²çªå‡çº§æ—¶ï¼Œé€æ¸æ”¶ç´§æ™¯åˆ«ï¼ˆå¦‚ä»ä¸­æ™¯åˆ°è¿‘æ™¯å†åˆ°ç‰¹å†™ï¼‰ï¼ŒåŒæ—¶å¯ä»¥åŠ å¿«å‰ªè¾‘é¢‘ç‡ï¼ˆç¼©çŸ­æ¯ä¸ªé•œå¤´çš„æ—¶é•¿ï¼‰ï¼›åœ¨é‡è¦æ—¶åˆ»æˆ–è½¬æŠ˜ç‚¹ï¼Œçªç„¶åˆ‡å›ä¸€ä¸ªå…¨æ™¯æˆ–æ¾ä¸€ç‚¹çš„æ™¯åˆ«ã€‚ä½†é¿å…æ™¯åˆ«åˆ‡æ¢å¤§å¼€å¤§åˆï¼Œå¿½è¿œå¿½è¿‘ã€‚
    è®©æ™¯åˆ«çš„å˜åŒ–æœ‰çº¿æ€§è¶‹åŠ¿ï¼Œæˆ–ä¿æŒä¸€æ®µæ—¶é—´çš„ç¨³å®šæ™¯åˆ«ï¼Œé¿å…æ— æ„ä¹‰çš„ä¹±åˆ‡ã€‚
    é™¤äº†äººç‰©å¯¹è¯æ­£åæ‰“ä¹‹å¤–ï¼Œä¸¤ä¸ªæ™¯åˆ«ç›¸ä¼¼ã€æ„å›¾ç›¸ä¼¼çš„é•œå¤´ä¸èƒ½ç›´æ¥è¿åœ¨ä¸€èµ·ã€‚è¿æ¥ä¸¤ä¸ªåŒæ™¯åˆ«é•œå¤´æ—¶ï¼Œä¸­é—´å¯ä»¥æ’å…¥ä¸€ä¸ªä¸åŒæ™¯åˆ«çš„é•œå¤´æ¥è¿‡æ¸¡ã€‚
    é•œå¤´è§’åº¦åŸåˆ™ï¼š
    é€šè¿‡æ­£é¢/ä¾§é¢çš„åˆ‡æ¢è¾…åŠ©é•œå¤´ä¹‹é—´çš„è¡”æ¥ï¼Œé€šè¿‡ä¿¯è§’/ä»°è§’å±•ç¤ºäººç‰©æ‰€å¤„çš„åœ°ä½ï¼Œå¦‚é«˜é«˜åœ¨ä¸Šï¼Œæˆ–å‘å¾®ã€‚é€šè¿‡POVæ¨¡æ‹Ÿè§’è‰²çš„è§†è§’ï¼Œæä¾›æ²‰æµ¸å¼ä½“éªŒã€‚
    å¯¹äºæ¶‰åŠæ­£åæ‰“çš„å¯¹è¯æˆï¼Œéœ€è¦æ ¹æ®ç»™å‡ºçš„ä¸»é•œå¤´ï¼Œåˆ†æäººç‰©å¯¹è¯çš„ä½ç½®å…³ç³»ï¼Œå¹¶è®¾è®¡å‡ºè½´çº¿ã€‚è®©äººç‰©è§†çº¿é¢æœå¯¹è¯çš„å¯¹æ–¹ï¼Œä¸¥ç¦äººç‰©æ­£å¯¹ã€ç›´è§†é•œå¤´ï¼Œè®¾è®¡å‡ºç¬¦åˆè½´çº¿é€»è¾‘çš„æ­£åæ‰“é•œå¤´ã€‚æœ€å¥½åœ¨åˆé€‚çš„ä½ç½®è¿ç”¨è¿ç”¨3/4 Shotå’ŒOTSã€‚
    é•œå¤´è¿åŠ¨åŸåˆ™ï¼š
    çªå‡ºè¯¥æ®µå‰§æƒ…å†…å®¹æ‰€è¦è¡¨è¾¾çš„å‰§æƒ…/æƒ…æ„Ÿã€‚æ¯”å¦‚æ¨è¿‘-çªå‡ºäººç‰©çš„æƒ…ç»ªï¼›æ‹‰è¿œ-å±•ç¤ºç¯å¢ƒï¼Œä¼—äººçš„ååº”ç­‰ã€‚
    å°è¯ï¼šå†™è‹±æ–‡ï¼Œè¦åœ°é“ä¸”å‡†ç¡®ã€‚
    """


# ==========================================
# 3. LLM æœåŠ¡ (ä¿®æ”¹ç‰ˆï¼šæ”¯æŒçœŸå® API)
# ==========================================
class LLMService:
    def __init__(self):
        self.provider = "Mock (æ¼”ç¤º)"
        self.api_key = ""
        self.model_name = ""

    def set_config(self, provider, api_key, model_name):
        self.provider = provider
        self.api_key = api_key
        self.model_name = model_name

    def generate(self, system_prompt: str, user_prompt: str) -> str:
        # 1. Mock æ¨¡å¼
        if self.provider == "Mock (æ¼”ç¤º)":
            return self._mock_response(user_prompt)

        # 2. çœŸå® API æ£€æŸ¥
        if not self.api_key:
            return "âŒ é”™è¯¯ï¼šè¯·åœ¨ä¾§è¾¹æ å¡«å†™ API Key"

        try:
            if self.provider == "Google Gemini":
                return self._call_gemini(system_prompt, user_prompt)
            elif self.provider == "OpenAI (GPT)":
                return self._call_openai(system_prompt, user_prompt)
            elif self.provider == "Anthropic (Claude)":
                return self._call_claude(system_prompt, user_prompt)
            else:
                return "âŒ æœªçŸ¥æ¨¡å‹æä¾›å•†"
        except Exception as e:
            return f"âŒ API è°ƒç”¨å¼‚å¸¸: {str(e)}"

    # --- çœŸå®æ¨¡å‹è°ƒç”¨æ¥å£ ---

    def _call_gemini(self, system_prompt, user_prompt):
        if not genai: return "âŒ è¯·å®‰è£…åº“: pip install google-generativeai"
        genai.configure(api_key=self.api_key)
        # Gemini çš„ System Prompt åœ¨åˆå§‹åŒ–æ—¶ä¼ å…¥
        model = genai.GenerativeModel(
            model_name=self.model_name,
            system_instruction=system_prompt
        )
        response = model.generate_content(user_prompt)
        return response.text

    def _call_openai(self, system_prompt, user_prompt):
        if not openai: return "âŒ è¯·å®‰è£…åº“: pip install openai"
        client = openai.OpenAI(api_key=self.api_key)
        response = client.chat.completions.create(
            model=self.model_name,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.7
        )
        return response.choices[0].message.content

    def _call_claude(self, system_prompt, user_prompt):
        if not anthropic: return "âŒ è¯·å®‰è£…åº“: pip install anthropic"
        client = anthropic.Anthropic(api_key=self.api_key)
        response = client.messages.create(
            model=self.model_name,
            max_tokens=4096,
            system=system_prompt,
            messages=[{"role": "user", "content": user_prompt}]
        )
        return response.content[0].text

    # --- Mock æ•°æ® ---
    def _mock_response(self, prompt_content: str) -> str:
        time.sleep(1.5)  # æ¨¡æ‹Ÿ AI æ€è€ƒ

        # Mock 1: ä¸‰å¹•å¼åˆ›æ„
        if "ä¸‰å¹•å¼åˆ›æ„" in prompt_content:
            return """
Option 1:
å‰§åï¼šGlobal Freeze: The Safe House (å…¨çƒå†°å°ï¼šå®‰å…¨å±‹)
ç±»å‹ï¼šæœ«ä¸–/é‡ç”Ÿ
Act 1: ä¸»è§’é‡ç”Ÿå›æœ«æ—¥å‰30å¤©ï¼Œç–¯ç‹‚å›¤ç§¯ç‰©èµ„ï¼Œæ‰“é€ å ¡å’ã€‚
Act 2: å†°å°é™ä¸´ï¼Œå‰ä¸–çš„ä»‡äººè¯•å›¾æ”»ç ´å®‰å…¨å±‹ï¼Œä¸»è§’åœ¨å±‹å†…äº«å—çº¢é…’ç‰›æ’ã€‚
Act 3: ä¸»è§’ä¸»åŠ¨å‡ºå‡»ï¼Œåˆ©ç”¨é™·é˜±å›¢ç­ä»‡äººï¼Œåœ¨è¿™ä¸ªæ–°ä¸–ç•Œç§°ç‹ã€‚

Option 2:
å‰§åï¼šLow Res Life (ä½ç”»è´¨äººç”Ÿ)
ç±»å‹ï¼šèµ›åšæœ‹å…‹/æƒŠæ‚š
Act 1: ç©·äººçœ¼é‡Œä¸–ç•Œæ˜¯é©¬èµ›å…‹ã€‚ä¸»è§’ä¸ºçœ‹æ¸…äº¡æ¯é—å®¹è´­ä¹°éæ³•é«˜æ¸…èŠ¯ç‰‡ã€‚
Act 2: èŠ¯ç‰‡å¼€å¯ï¼Œå‘ç°â€œä¸Šæµç¤¾ä¼šâ€å…¶å®æ˜¯å¤–æ˜Ÿæ€ªç‰©ï¼Œäººç±»åªæ˜¯é¥²æ–™ã€‚
Act 3: ä¸»è§’æ½œå…¥ä¸­å¤®æœåŠ¡å™¨ï¼Œä¸Šä¼ â€œé«˜æ¸…ç—…æ¯’â€ï¼Œè¿«ä½¿å…¨äººç±»è§‰é†’ã€‚

Option 3:
å‰§åï¼šThe Fake Heiress (è±ªé—¨å‡åƒé‡‘)
ç±»å‹ï¼šé€†è¢­/æ‰“è„¸
Act 1: çœŸåƒé‡‘å›å½’ï¼Œä¸»è§’è¢«èµ¶å‡ºè±ªé—¨ï¼Œæµè½è¡—å¤´ã€‚
Act 2: ä¸»è§’å±•ç°æƒŠäººå•†ä¸šå¤©èµ‹ï¼Œåˆ›ç«‹å…¬å¸æ”¶è´­å…»çˆ¶é›†å›¢ã€‚
Act 3: çœŸç›¸å¤§ç™½ï¼Œä¸»è§’å…¶å®æ˜¯æ›´é¡¶çº§è´¢é˜€çš„é—ç ï¼Œç‹ ç‹ æ‰“è„¸å…»çˆ¶æ¯ã€‚
            """

        # Mock 2: 30é›†å¤§çº²
        elif "åˆ†é›†å¤§çº²" in prompt_content:
            return """
**30-Episode Outline**

**EPISODE 1: The Glitch**
Hook: Bella mocks a beggar at the gala. Suddenly, her vision glitches.
Plot: Her subscription fails. She sees the beggar as a 4K monster.
Cliffhanger: Security drags her away as she screams "Monsters!"

**EPISODE 2: The Downfall**
Hook: Bella wakes up in the Slums (144p resolution).
Plot: She meets Marcus, a hacker. He offers her a jailbroken chip.
Cliffhanger: The chip installation is painful. She stops breathing.

**EPISODE 3 - 29**
(Story progresses: Bella leads the rebellion, Marcus betrays her, then redeems himself...)

**EPISODE 30: The Awakening**
Hook: Bella confronts the Overlord.
Plot: She broadcasts the 8K reality to everyone. Chaos ensues.
Cliffhanger: The sky cracks open. It wasn't aliens; it was a simulation all along.
            """

        # Mock 3: åˆ†é•œè„šæœ¬ (å®Œæ•´ CSV æ ¼å¼)
        elif "åˆ†é•œ" in prompt_content:
            # ä½¿ç”¨åˆ—è¡¨æ‹¼æ¥ï¼Œé¿å…é•¿å­—ç¬¦ä¸²æ¢è¡Œå¯¼è‡´çš„ SyntaxError
            csv_lines = [
                "é•œå·,åœºæ™¯,ç”»é¢å†…å®¹ (Visual),å°è¯ (Dialogue) & éŸ³æ•ˆ (SFX)",
                '1,å®´ä¼šå…,"Bellaç«™åœ¨èšå…‰ç¯ä¸‹ï¼Œé«˜ä¸¾é…’æ¯ï¼Œçœ¼ç¥è½»è”‘ã€‚","Bella: ""To the elite! The rest... are just pixels."""',
                '2,å®´ä¼šå…,"ä¼—äººæ¬¢å‘¼ï¼Œç”»é¢çªç„¶é—ªçƒå‡ºé›ªèŠ±ç‚¹ã€‚","SFX: Glitch sound. Crowd: (Cheering)"',
                '3,Bellaè§†è§’(POV),"åŸæœ¬åä¸½çš„å®¾å®¢ç¬é—´å˜æˆä¸€å †è‰²å—ã€‚","Bella: ""What... what is happening?"""',
                '4,ç‰¹å†™,"Bellaæ‰çœ¼ç›ï¼ŒæƒŠæåœ°çœ‹å‘è‡ªå·±çš„æ‰‹ï¼Œæ‰‹å˜æˆäº†é©¬èµ›å…‹ã€‚","Bella: ""My hand! It\'s... loading?"""',
                '5,å…¨æ™¯,"ä¿å®‰å†²ä¸Šæ¥ï¼Œæ‰‹ä¸­çš„ç”µæ£å‘å‡ºè“å…‰ã€‚","Security: ""Subscription expired, Ma\'am."""',
                '6,ç‰¹å†™,"ç”µæ£å‡»ä¸­Bellaï¼Œç”»é¢é»‘å±ã€‚","SFX: ZAP! Bella: ""Nooooo!"""'
            ]
            return "\n".join(csv_lines)

        return "Unknown Prompt"


# ==========================================
# 4. çŠ¶æ€ç®¡ç†
# ==========================================
# ç¡®ä¿ Service å®ä¾‹å­˜åœ¨
if 'llm_service' not in st.session_state:
    st.session_state.llm_service = LLMService()

# å¸¸ç”¨ State åˆå§‹åŒ–
if 'generated_acts' not in st.session_state: st.session_state.generated_acts = None
if 'selected_act' not in st.session_state: st.session_state.selected_act = None
if 'outline' not in st.session_state: st.session_state.outline = None
if 'scripts' not in st.session_state: st.session_state.scripts = {}

llm_service = st.session_state.llm_service

# ==========================================
# 5. ä¸»ç¨‹åº UI
# ==========================================
st.markdown('<div class="main-header">ğŸ¬ AI çŸ­å‰§å‰§æœ¬å…¨æµç¨‹ç”Ÿæˆå·¥å…· (Pro)</div>', unsafe_allow_html=True)

# --- ä¾§è¾¹æ  (ä¿®æ”¹ï¼šä¸‹æ‹‰èœå•) ---
with st.sidebar:
    st.header("âš™ï¸ æ¨¡å‹é…ç½®")

    # 1. é€‰æ‹©æä¾›å•†
    provider = st.selectbox(
        "é€‰æ‹©æ¨¡å‹å‚å•†",
        ["Google Gemini", "OpenAI (GPT)", "Anthropic (Claude)"]
    )

    # 2. åŠ¨æ€è¾“å…¥ Key å’Œ æ¨¡å‹åç§° (å·²ä¿®æ”¹ä¸ºä¸‹æ‹‰æ¡†)
    api_key = ""
    model_name = ""

    if provider != "Mock (æ¼”ç¤º)":
        api_key = st.text_input("API Key", type="password")

        # âœ… ä¿®æ”¹ç‚¹ï¼šä½¿ç”¨ selectbox æ›¿ä»£ text_input
        if provider == "Google Gemini":
            model_name = st.selectbox(
                "é€‰æ‹©æ¨¡å‹",
                ["gemini-3-flash-preview", "gemini-3-pro-preview","gemini-3.1-pro-preview"]
            )
        elif provider == "OpenAI (GPT)":
            model_name = st.selectbox(
                "é€‰æ‹©æ¨¡å‹",
                ["gpt-4o", "gpt-4-turbo", "gpt-4o-mini", "gpt-3.5-turbo"]
            )
        elif provider == "Anthropic (Claude)":
            model_name = st.selectbox(
                "é€‰æ‹©æ¨¡å‹",
                ["claude-3-5-sonnet-20240620", "claude-3-opus-20240229", "claude-3-haiku-20240307"]
            )

    # æ›´æ–° Service é…ç½®
    llm_service.set_config(provider, api_key, model_name)

    st.divider()
    st.markdown("**åŠŸèƒ½å¯¼èˆª**")
    st.markdown("- Step 1: åˆ›æ„ç”Ÿæˆ")
    st.markdown("- Step 2: å¤§çº²æ‹†è§£")
    st.markdown("- Step 3: åˆ†é•œè„šæœ¬")

# --- Step 1: åŸå§‹åˆ›æ„ ---
st.markdown("### 1ï¸âƒ£ åŸå§‹åˆ›æ„è¾“å…¥")
st.markdown('<div class="info-box">åœ¨æ­¤è¾“å…¥æ‚¨çš„åŸå§‹æƒ³æ³•ï¼ŒAI å°†ä¸ºæ‚¨æ‹†è§£ä¸ºç¬¦åˆå¥½è±åæ ‡å‡†çš„ä¸‰å¹•å¼ç»“æ„ã€‚</div>',
            unsafe_allow_html=True)

# é»˜è®¤åˆ›æ„æ–‡æœ¬
default_idea = """Resolution: Lowã€Šä½ç”»è´¨äººç”Ÿã€‹
2099å¹´ï¼Œè§†è§‰æ„ŸçŸ¥æˆä¸ºä¸€ç§æ˜‚è´µçš„è®¢é˜…æœåŠ¡ã€‚å¯Œäººäº«å—ç€8K HDRçš„æè‡´ä¸–ç•Œï¼Œè€Œåƒå‡¯è¿™æ ·çš„ç©·äººåªèƒ½æ´»åœ¨â€œç»æµæ¨¡å¼â€é‡Œâ€”â€”ä¸€ä¸ªæ¨¡ç³Šã€åƒç´ åŒ–çš„144på™©æ¢¦ã€‚å‡¯ä¸ºäº†çœ‹æ¸…ç—…å±æ¯äº²çš„è„¸ï¼Œåœ¨é»‘å¸‚è´­ä¹°äº†è¿ç¦èŠ¯ç‰‡ï¼Œç»“æœå‘ç°â€œé«˜æ¸…â€ä¸–ç•Œé‡Œï¼Œç»Ÿæ²»è€…å…¶å®æ˜¯é£Ÿäººæ€ªç‰©ï¼Œè€Œâ€œä½ç”»è´¨â€åªæ˜¯ä¸ºäº†æ©ç›–çœŸç›¸çš„æ»¤é•œã€‚"""

original_idea = st.text_area("è¯·è¾“å…¥åŸå§‹åˆ›æ„ï¼š", value=default_idea, height=150)

if st.button("ç”Ÿæˆä¸‰å¹•å¼åˆ›æ„ (Step 1)", type="primary"):
    with st.spinner(f"æ­£åœ¨ä½¿ç”¨ {provider} ç”Ÿæˆä¸‰å¹•å¼åˆ›æ„..."):
        prompt = Prompts.ACT_GEN_TASK + f"\n[åŸå§‹åˆ›æ„]\n{original_idea}"
        res = llm_service.generate(Prompts.ACT_GEN_SYSTEM, prompt)
        st.session_state.generated_acts = res
        if not res.startswith("âŒ"):
            st.success("âœ… ä¸‰å¹•å¼åˆ›æ„ç”Ÿæˆå®Œæˆï¼")
        else:
            st.error(res)

# --- Step 2: å¤§çº²ç”Ÿæˆ ---
if st.session_state.generated_acts:
    st.divider()
    st.markdown("### 2ï¸âƒ£ ç¡®è®¤ä¸‰å¹•å¼ & ç”Ÿæˆå¤§çº²")

    with st.expander("ğŸ“„ æŸ¥çœ‹ç”Ÿæˆçš„ä¸‰ä¸ªåˆ›æ„æ–¹æ¡ˆ", expanded=True):
        # âœ… ä¿®æ”¹ç‚¹ 2ï¼šé«˜åº¦å¢åŠ ä¸€å€ (200 -> 400)
        st.text_area("AI å»ºè®®æ–¹æ¡ˆï¼š", value=st.session_state.generated_acts, height=400, disabled=True)

    st.info("è¯·å¤åˆ¶æ‚¨æœ€æ»¡æ„çš„ä¸€ä¸ªæ–¹æ¡ˆï¼ˆæˆ–æ‰‹åŠ¨ä¿®æ”¹ï¼‰åˆ°ä¸‹æ–¹è¾“å…¥æ¡†ï¼Œç”¨äºç”Ÿæˆ 30 é›†å¤§çº²ã€‚")

    # è‡ªåŠ¨æå– Mock æ•°æ®ä¸­çš„ Option 2 ä½œä¸ºé»˜è®¤å€¼ï¼Œæ–¹ä¾¿æ¼”ç¤º
    default_choice = ""
    if "Option 2:" in st.session_state.generated_acts:
        default_choice = st.session_state.generated_acts.split("Option 2:")[-1].split("Option 3:")[0].strip()

    user_choice = st.text_area("ç¡®è®¤é€‰ç”¨çš„å‰§æœ¬æ–¹æ¡ˆï¼š", value=default_choice, height=150)

    if st.button("ç”Ÿæˆ 30 é›†åˆ†é›†å¤§çº² (Step 2)", type="primary"):
        st.session_state.selected_act = user_choice
        with st.spinner(f"æ­£åœ¨ä½¿ç”¨ {provider} æ„æ€ 30 é›†å‰§æƒ…..."):
            prompt = Prompts.OUTLINE_TASK + f"\n[ä¸‰å¹•å¼åˆ›æ„]\n{user_choice}"
            res = llm_service.generate(Prompts.OUTLINE_SYSTEM, prompt)
            st.session_state.outline = res
            if not res.startswith("âŒ"):
                st.success("âœ… 30 é›†å¤§çº²ç”Ÿæˆå®Œæ¯•ï¼")
            else:
                st.error(res)

# --- Step 3: åˆ†é•œè„šæœ¬ ---
    if st.session_state.outline:
        st.divider()
        st.markdown("### 3ï¸âƒ£ åˆ†é•œè„šæœ¬ç”Ÿæˆ")

        # âœ… [æ–°å¢] æç¤ºç”¨æˆ·å¯ä»¥è‡ªç”±ç¼–è¾‘å¤§çº²
        st.info(
            "ğŸ’¡ **æç¤º**ï¼šæ‚¨å¯ä»¥åœ¨ä¸‹æ–¹æ–‡æœ¬æ¡†ä¸­è‡ªç”±ä¿®æ”¹ AI ç”Ÿæˆçš„å¤§çº²ã€‚ç¡®è®¤æ— è¯¯åç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œç³»ç»Ÿå°†ä¸¥æ ¼åŸºäºæ‚¨**ä¿®æ”¹å**çš„å¤§çº²ç”Ÿæˆåˆ†é•œã€‚")

        with st.expander("ğŸ“„ æŸ¥çœ‹ä¸æ‰‹åŠ¨ç¼–è¾‘ 30 é›†å¤§çº²", expanded=True):
            # âœ… [æ ¸å¿ƒä¿®æ”¹] å°† st.markdown æ›¿æ¢ä¸º st.text_areaï¼Œä½¿å…¶å˜ä¸ºå¯ç¼–è¾‘çŠ¶æ€
            # Streamlit ä¼šè‡ªåŠ¨æ•æ‰ç”¨æˆ·çš„è¾“å…¥ï¼Œæˆ‘ä»¬å°†å…¶é‡æ–°èµ‹å€¼ç»™ session_state.outline
            edited_outline = st.text_area(
                "è¯·åœ¨æ­¤å¤„ä¿®æ”¹æˆ–å®Œå–„å¤§çº²å†…å®¹ï¼š",
                value=st.session_state.outline,
                height=400
            )
            # å®æ—¶è¦†ç›–æ—§çŠ¶æ€ï¼šç¡®ä¿åç»­è°ƒç”¨çš„ gen_script å‡½æ•°æ‹¿åˆ°çš„æ˜¯äººå·¥ä¿®æ”¹åçš„æœ€æ–°ç‰ˆæœ¬
            st.session_state.outline = edited_outline

        st.markdown("**è¯·é€‰æ‹©ç”Ÿæˆæ‰¹æ¬¡ï¼ˆæ¯æ¬¡ 10 é›†ï¼‰ï¼š**")
    c1, c2, c3 = st.columns(3)


    # å®šä¹‰ç”Ÿæˆå‡½æ•°
    def gen_script(label, r):
        with st.spinner(f"æ­£åœ¨ä½¿ç”¨ {provider} ç”Ÿæˆ {label} åˆ†é•œ..."):
            p = Prompts.SCRIPT_TASK_TEMPLATE.format(episode_range=r) + f"\n[å¤§çº²]\n{st.session_state.outline}"
            res = llm_service.generate(Prompts.SCRIPT_SYSTEM, p)
            st.session_state.scripts[label] = res
            if not res.startswith("âŒ"):
                st.success(f"âœ… {label} ç”ŸæˆæˆåŠŸï¼")
            else:
                st.error(res)


    with c1:
        if st.button("ç”Ÿæˆ 1-10 é›†"): gen_script("1-10é›†", "1-10")
    with c2:
        if st.button("ç”Ÿæˆ 11-20 é›†"): gen_script("11-20é›†", "11-20")
    with c3:
        if st.button("ç”Ÿæˆ 21-30 é›†"): gen_script("21-30é›†", "21-30")

    # ç»“æœå±•ç¤ºåŒº
    if st.session_state.scripts:
        st.markdown("#### ğŸ“œ è„šæœ¬é¢„è§ˆä¸ä¸‹è½½")
        tabs = st.tabs(list(st.session_state.scripts.keys()))

        for i, (key, content) in enumerate(st.session_state.scripts.items()):
            with tabs[i]:
                try:
                    # [Step 1] æ­£åˆ™å®šä½å†…å®¹
                    match = re.search(r"((ç¬¬\s*\d+\s*é›†|Episode|é•œå·).*$)", content, re.DOTALL)

                    if match:
                        csv_text = match.group(1).strip()
                        csv_text = re.sub(r'```\w*\n?', '', csv_text).replace('```', '').strip()

                        import csv

                        data_rows = []
                        reader = csv.reader(csv_text.splitlines())

                        for row in reader:
                            if not row: continue

                            row = [str(x).strip() for x in row]

                            # --- é€»è¾‘ Aï¼šè¯†åˆ«åˆ†é›†æ ‡é¢˜è¡Œ ---
                            row_str = "".join(row)
                            if (len(row) == 1 or (len(row) < 3 and len(row_str) < 20)) and (
                                    "é›†" in row_str or "Episode" in row_str):
                                title = row[0].replace(",", "")
                                data_rows.append([f"ğŸ¬ {title} ğŸ¬", "", "", ""])
                                continue

                            # --- é€»è¾‘ Bï¼šå¤„ç†è¡¨å¤´ ---
                            if "é•œå·" in row[0]:
                                continue

                            # --- é€»è¾‘ Cï¼šæ•°æ®è¡Œæ ¼å¼åŒ– (ğŸŒŸæ ¸å¿ƒä¿®å¤ï¼šæ™ºèƒ½åˆ†ç¦»ç”»é¢ä¸å°è¯) ---
                            processed_row = []
                            if len(row) >= 3:
                                if len(row) == 3: row.append("")

                                # å°†ç¬¬3åˆ—åŠä¹‹åçš„æ‰€æœ‰å†…å®¹åˆå¹¶ï¼Œæˆ‘ä»¬ä¾é ç‰¹å¾æ¥æ‰‹åŠ¨åˆ‡åˆ†
                                rest_text = ",".join(row[2:])

                                # æ­£åˆ™å¯»æ‰¾å°è¯èµ·ç‚¹ï¼š(å¥é¦–æˆ–æ ‡ç‚¹) + (2-25ä½è‹±æ–‡å/æ‹¬å·) + å†’å· + éç©ºç™½å­—ç¬¦
                                # ä¾‹å¦‚ï¼šè¯†åˆ« ",Maya: L" æˆ– "ã€‚SFX: ("
                                match_dialogue = re.search(r'(?:^|[,ã€‚ï¼ï¼Ÿâ€\s])\s*([A-Za-z0-9\s\(\)\-]{2,25}:\s*\S)',
                                                           rest_text)

                                if match_dialogue:
                                    # match_dialogue.start(1) èƒ½å¤Ÿç²¾ç¡®å®šä½åˆ° "Maya:" çš„ M å­—æ¯
                                    idx = match_dialogue.start(1)
                                    # åˆ‡ç‰‡åˆ†ç¦»
                                    visual_part = rest_text[:idx].strip(' ,\"')
                                    dialogue_part = rest_text[idx:].strip(' ,\"')
                                    processed_row = [row[0], row[1], visual_part, dialogue_part]
                                else:
                                    # å¦‚æœæ²¡æœ‰ç‰¹å¾å°è¯æ ‡è¯†ï¼Œé€€å›å®‰å…¨æ¨¡å¼
                                    if len(row) == 4:
                                        processed_row = row
                                    else:
                                        processed_row = [row[0], row[1], ",".join(row[2:-1]), row[-1]]
                            elif len(row) < 3:
                                row.extend([""] * (4 - len(row)))
                                processed_row = row

                            # --- [Step 3.5] é€»è¾‘ Eï¼šå¼ºåŠ›æ¸…æ´—æ™¯åˆ«å…³é”®è¯ (ä¿ç•™ä¸Šä¸€ç‰ˆçš„ä¼˜åŒ–) ---
                            if processed_row and len(processed_row) == 4:
                                clean_visual = re.sub(r'ã€.*?ã€‘|\[.*?\]', '', processed_row[2]).strip()
                                processed_row[2] = clean_visual

                            # --- é€»è¾‘ Dï¼šéšå¼åˆ†é›†æ£€æµ‹ ---
                            if processed_row and processed_row[0] == "1" and len(data_rows) > 0:
                                if "ğŸ¬" not in data_rows[-1][0]:
                                    data_rows.append(["ğŸ¬ ä¸‹ä¸€é›† / Next Episode ğŸ¬", "", "", ""])

                            if processed_row:
                                data_rows.append(processed_row)

                        # [Step 4] æ„å»º DataFrame
                        header_list = ["é•œå·", "åœºæ™¯", "ç”»é¢å†…å®¹ (Visual)", "å°è¯ (Dialogue) & éŸ³æ•ˆ (SFX)"]

                        if len(data_rows) > 0:
                            df = pd.DataFrame(data_rows, columns=header_list)
                        else:
                            df = pd.DataFrame(columns=header_list)

                        # [Step 5] æ ·å¼å¤åˆ»
                        st.dataframe(
                            df,
                            use_container_width=True,
                            hide_index=True,
                            column_config={
                                "é•œå·": st.column_config.TextColumn("é•œå·", width="small"),
                                "åœºæ™¯": st.column_config.TextColumn("åœºæ™¯", width="medium"),
                                "ç”»é¢å†…å®¹ (Visual)": st.column_config.TextColumn("ç”»é¢å†…å®¹ (Visual)", width="large"),
                                "å°è¯ (Dialogue) & éŸ³æ•ˆ (SFX)": st.column_config.TextColumn(
                                    "å°è¯ (Dialogue) & éŸ³æ•ˆ (SFX)", width="large"),
                            }
                        )

                        # [Step 6] ä¸‹è½½æŒ‰é’® (ä¿ç•™é˜²ä¹±ç çš„ utf-8-sig)
                        csv_out = df.to_csv(index=False).encode('utf-8-sig')

                        st.download_button(
                            label=f"ğŸ“¥ ä¸‹è½½ {key} CSV (Excelä¸“ç”¨ç‰ˆ)",
                            data=csv_out,
                            file_name=f"script_{key}.csv",
                            mime='text/csv'
                        )
                    else:
                        st.warning("âš ï¸ æœªæ£€æµ‹åˆ°æœ‰æ•ˆå†…å®¹ï¼Œè¯·æ£€æŸ¥ç”Ÿæˆç»“æœã€‚")
                        st.text(content)

                except Exception as e:
                    st.error(f"âš ï¸ è§£æå¼‚å¸¸: {e}")
                    st.text("åŸå§‹è¿”å›å†…å®¹ï¼š")
                    st.text(content)